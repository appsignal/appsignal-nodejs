semaphore: # Default `.semaphore/semaphore.yml` contents
  version: v1.0
  name: AppSignal for Node.js
  agent:
    machine:
      type: e1-standard-2
      os_image: ubuntu2004
  auto_cancel:
    running:
      when: branch != 'main' AND branch != 'develop'
  global_job_config:
    env_vars:
    - name: RUNNING_IN_CI
      value: 'true'
    - name: NODE_ENV
      value: test
    - name: _PACKAGES_CACHE
      value: v1
    - name: _BUNDLER_CACHE
      value: v1
    prologue:
      commands:
        - checkout
        - "[ -n \"$NODE_VERSION\" ] && sem-version node $NODE_VERSION || echo Skipping Node.js install"

        # Mono setup
        - script/setup
        - source ~/.bashrc
  blocks:
    - name: Validation
      dependencies: []
      task:
        jobs:
        - name: Validate CI setup
          commands:
            - rake build_matrix:semaphore:validate
    - name: Linters
      dependencies: []
      task:
        jobs:
        - name: Ruby Lint (RuboCop)
          commands:
            - cache restore $_BUNDLER_CACHE-bundler-$(checksum Gemfile.lock)
            - bundle config set clean 'true'
            - bundle config set path .bundle
            - bundle install --jobs=3 --retry=3
            - cache store $_BUNDLER_CACHE-bundler-$(checksum Gemfile.lock) .bundle
            - bundle exec rubocop
        - name: Node.js Lint (Prettier)
          env_vars:
            - name: NODE_VERSION
              value: "16"
          commands:
            - cache restore
            - mono bootstrap --ci
            - cache store
            - npm run lint
        - name: Git Lint (Lintje)
          commands:
            - script/lint_git

matrix:
  epilogue: # Shared for all jobs in the build matrix
    always:
      commands:
        - ""

  nodejs:
    - nodejs: "18"
      setup:
        # Use NPM version 8.5.3 to work around a bug when using NPM 8.5.4 or
        # higher, where commands that are ran at the root of the workspace
        # do not trigger lifecycle hooks for the workspace packages.
        # https://github.com/npm/cli/issues/4552
        - &npm853 npm i -g npm@8.5.3
      env_vars:
        # Set `NODE_OPTIONS` to `--openssl-legacy-provider`, as a workaround
        # for this `webpack` bug affecting the `@appsignal/nextjs` tests
        # when running on Node 17:
        # https://github.com/webpack/webpack/issues/14532
        # https://github.com/nodejs/node/issues/40455
        - name: NODE_OPTIONS
          value: "--openssl-legacy-provider"
    - nodejs: "17"
      setup:
        - *npm853
      env_vars:
        # Set `NODE_OPTIONS` to `--openssl-legacy-provider`, as a workaround
        # for this `webpack` bug affecting the `@appsignal/nextjs` tests
        # when running on Node 17:
        # https://github.com/webpack/webpack/issues/14532
        # https://github.com/nodejs/node/issues/40455
        - name: NODE_OPTIONS
          value: "--openssl-legacy-provider"
    - nodejs: "16"
      setup:
        - *npm853
    - nodejs: "14"
      setup:
        - *npm853
  packages:
    - package: "@appsignal/nodejs"
      path: "packages/nodejs"
      variations:
        - name: "nodejs"
      extra_tests:
        diagnose:
          - git submodule init
          - git submodule update
          - LANGUAGE=nodejs test/integration/diagnose/bin/test
      extra_commands:
        - mono run --package @appsignal/nodejs -- npm run test:failure
    # Library integrations
    - package: "@appsignal/apollo-server"
      path: "packages/apollo-server"
      variations:
        - name: "apollo-server@latest"
          packages:
            apollo-server-plugin-base: "latest"
        - name: "apollo-server@3.4.0"
          packages:
            apollo-server-plugin-base: "3.4.0"
        - name: "apollo-server@3.3.0"
          packages:
            apollo-server-plugin-base: "3.3.0"
        - name: "apollo-server@3.2.0"
          packages:
            apollo-server-plugin-base: "3.2.0"
      extra_tests:
        integrations:
          - script/test_package_integration apollo-server
    - package: "@appsignal/express"
      path: "packages/express"
      variations:
        - name: "express@latest"
          packages:
            express: "latest"
        - name: "express@4.17.1"
          packages:
            express: "4.17.1"
      extra_tests:
        integrations:
          - script/test_package_integration express
    - package: "@appsignal/koa"
      path: "packages/koa"
      variations:
        - name: "koa@latest"
          packages:
            koa: "latest"
        - name: "koa@2.13.1"
          packages:
            koa: "2.13.1"
        - name: "koa@2.12.1"
          packages:
            koa: "2.12.1"
      extra_tests:
        integrations:
          - script/test_package_integration koa
    - package: "@appsignal/nextjs"
      path: "packages/nextjs"
      variations:
        - name: "next.js@latest"
          packages:
            next: "latest"
            react: "latest"
            react-dom: "latest"
        - name: "next.js@12.1.0"
          packages:
            next: "12.1.0"
            react: "17.0.2"
            react-dom: "17.0.2"
        - name: "next.js@11.1.4"
          packages:
            next: "11.1.4"
            react: "17.0.2"
            react-dom: "17.0.2"
        - name: "next.js@10.2.3"
          packages:
            next: "10.2.3"
            react: "16.14.0"
            react-dom: "16.14.0"
      extra_tests:
        integrations:
          - script/test_package_integration nextjs
